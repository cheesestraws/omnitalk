#include "proto/nbp_test.h"
#include "mem/buffers_test.h"

#include "mem/buffers.h"
#include "proto/nbp.h"
#include "util/pstring.h"
#include "test.h"


TEST_FUNCTION(test_nbp_iteration) {
	buffer_t *buff;
	int i = 0;
	struct nbp_tuple_s *tuple;
	
	// A packet that has no nbp tuples, despite what the header claims
	char notuples[] = {0x01, 0x81, 0x01, 0x00, 0x29, 0xfd, 0x02, 0x02, 0x31, 0x0b};
	buff = buf_from_string(&notuples[0], 3, sizeof(notuples));
	buf_setup_ddp(buff, 3, BUF_SHORT_HEADER);
	for (i = 0, tuple = nbp_get_first_tuple(buff); tuple != NULL; i++, tuple = nbp_get_next_tuple(buff, tuple)) { }
	TEST_ASSERT(i == 0);
	freebuf(buff);
	
	// A packet that has a single NBP tuple
	char onetuple[] = {
		0x01, 0x81, 0x01, 0x00, 0x29, 0xfd, 0x02, 0x02, 0x31, 0x0b, 0xc9, 0xc9, 
		0xc9, 0xc9, 0x00, 0x10, 0x68, 0x65, 0x72, 0x6d, 0x65, 0x73, 0x2d, 0x73, 
		0x65, 0x6e, 0x73, 0x6f, 0x72, 0x6e, 0x65, 0x74, 0x09, 0x41, 0x69, 0x72, 
		0x54, 0x61, 0x6c, 0x6b, 0x41, 0x50, 0x01, 0x2a,
	};
	buff = buf_from_string(&onetuple[0], 3, sizeof(onetuple));
	buf_setup_ddp(buff, 3, BUF_SHORT_HEADER);
	for (i = 0, tuple = nbp_get_first_tuple(buff); tuple != NULL; i++, tuple = nbp_get_next_tuple(buff, tuple)) {}
	TEST_ASSERT(i == 1);
	freebuf(buff);

	
	char threetuples[] = {
		0x01, 0x81, 0x01, 0x00, 0x1f, 0xfd, 0x02, 0x02, 0x31, 0x0b,
		
		0xa9, 0xa9, 0xa9, 0xa9, 0x01, 0x06, 0x68, 0x65, 0x72, 0x6d, 0x65, 0x73, 0x09,
		0x41, 0x69, 0x72, 0x54, 0x61, 0x6c, 0x6b, 0x41, 0x50, 0x01, 0x2a,
		
		0xf7, 0xf7, 0xf7, 0xf7, 0x02, 0x07, 0x50, 0x52, 0x49, 0x4e, 0x54, 0x45, 0x52, 
		0x09, 0x41, 0x69, 0x72, 0x54, 0x61, 0x6c, 0x6b, 0x41, 0x50, 0x01, 0x2a,
		
		0xc9, 0xc9, 0xc9, 0xc9, 0x03, 0x10, 0x68, 0x65, 0x72, 0x6d, 0x65, 0x73, 0x2d, 
		0x73, 0x65, 0x6e, 0x73, 0x6f, 0x72, 0x6e, 0x65, 0x74, 0x09, 0x41, 0x69, 0x72, 
		0x54, 0x61, 0x6c, 0x6b, 0x41, 0x50, 0x01, 0x2a,
	};
	char* expected_objects[] = {
		"hermes", "PRINTER", "hermes-sensornet"
	};
	buff = buf_from_string(&threetuples[0], 3, sizeof(threetuples));
	buf_setup_ddp(buff, 3, BUF_SHORT_HEADER);
	for (i = 0, tuple = nbp_get_first_tuple(buff); tuple != NULL; i++, tuple = nbp_get_next_tuple(buff, tuple)) {
		TEST_ASSERT(pstring_eq_cstring(nbp_tuple_get_type(tuple), "AirTalkAP"));
		TEST_ASSERT(pstring_eq_cstring(nbp_tuple_get_zone(tuple), "*"));
		if (i < 3) {
			TEST_ASSERT(pstring_eq_cstring(nbp_tuple_get_object(tuple), expected_objects[i]));
		}
	}
	TEST_ASSERT(i == 3);
	freebuf(buff);

	
	TEST_OK();
}
